Version 4
SHEET 1 3748 852
WIRE -1648 -2496 -1824 -2496
WIRE -1568 -2496 -1648 -2496
WIRE -1408 -2496 -1488 -2496
WIRE -1264 -2496 -1360 -2496
WIRE -1216 -2496 -1264 -2496
WIRE -2096 -2480 -2128 -2480
WIRE -1968 -2480 -2016 -2480
WIRE -1936 -2480 -1968 -2480
WIRE -1264 -2464 -1264 -2496
WIRE -1408 -2448 -1408 -2496
WIRE -1360 -2432 -1360 -2496
WIRE -1936 -2416 -1936 -2480
WIRE -1824 -2416 -1824 -2496
WIRE -2096 -2256 -2128 -2256
WIRE -1968 -2256 -2016 -2256
WIRE -1936 -2256 -1936 -2336
WIRE -1936 -2256 -1968 -2256
WIRE -1824 -2256 -1824 -2336
WIRE -1408 -2256 -1408 -2368
WIRE -1408 -2256 -1824 -2256
WIRE -1360 -2256 -1360 -2384
WIRE -1264 -2256 -1264 -2384
WIRE -1264 -2256 -1360 -2256
WIRE -1216 -2256 -1264 -2256
WIRE -1824 -2208 -1824 -2256
WIRE 1984 -2176 1968 -2176
WIRE 2048 -2176 1984 -2176
WIRE 1248 -2160 1232 -2160
WIRE 1312 -2160 1248 -2160
WIRE 1968 -2160 1968 -2176
WIRE 1232 -2144 1232 -2160
WIRE 1968 -2064 1968 -2080
WIRE 1232 -2048 1232 -2064
WIRE 1312 -1968 1232 -1968
WIRE 1440 -1968 1392 -1968
WIRE 1520 -1968 1440 -1968
WIRE 1600 -1968 1520 -1968
WIRE 1232 -1952 1232 -1968
WIRE 1440 -1952 1440 -1968
WIRE 1440 -1872 1440 -1888
WIRE 1232 -1856 1232 -1872
WIRE -1792 -1808 -1840 -1808
WIRE -1664 -1808 -1712 -1808
WIRE -1584 -1808 -1664 -1808
WIRE -1520 -1808 -1584 -1808
WIRE -1840 -1792 -1840 -1808
WIRE -1184 -1792 -1264 -1792
WIRE -1104 -1792 -1184 -1792
WIRE -528 -1792 -592 -1792
WIRE -448 -1792 -528 -1792
WIRE 304 -1792 224 -1792
WIRE 432 -1792 384 -1792
WIRE 528 -1792 432 -1792
WIRE 592 -1792 528 -1792
WIRE -1664 -1776 -1664 -1808
WIRE -1264 -1776 -1264 -1792
WIRE -592 -1776 -592 -1792
WIRE 224 -1776 224 -1792
WIRE 432 -1776 432 -1792
WIRE -1840 -1696 -1840 -1712
WIRE -1664 -1696 -1664 -1712
WIRE 432 -1696 432 -1712
WIRE 1280 -1696 1232 -1696
WIRE 1328 -1696 1280 -1696
WIRE 1824 -1696 1776 -1696
WIRE 1888 -1696 1824 -1696
WIRE -1264 -1680 -1264 -1696
WIRE -592 -1680 -592 -1696
WIRE 224 -1680 224 -1696
WIRE 1232 -1680 1232 -1696
WIRE 1776 -1680 1776 -1696
WIRE -1792 -1584 -1840 -1584
WIRE -1664 -1584 -1712 -1584
WIRE -1568 -1584 -1664 -1584
WIRE -1520 -1584 -1568 -1584
WIRE -1232 -1584 -1264 -1584
WIRE -1104 -1584 -1232 -1584
WIRE -544 -1584 -592 -1584
WIRE -464 -1584 -544 -1584
WIRE 304 -1584 224 -1584
WIRE 432 -1584 384 -1584
WIRE 528 -1584 432 -1584
WIRE 592 -1584 528 -1584
WIRE 1232 -1584 1232 -1600
WIRE 1776 -1584 1776 -1600
WIRE -1840 -1568 -1840 -1584
WIRE -1264 -1568 -1264 -1584
WIRE -592 -1568 -592 -1584
WIRE 224 -1568 224 -1584
WIRE 432 -1568 432 -1584
WIRE -1664 -1552 -1664 -1584
WIRE 432 -1488 432 -1504
WIRE -1840 -1472 -1840 -1488
WIRE -1664 -1472 -1664 -1488
WIRE -1264 -1472 -1264 -1488
WIRE -592 -1472 -592 -1488
WIRE 224 -1472 224 -1488
WIRE 1328 -1456 1232 -1456
WIRE 1488 -1456 1408 -1456
WIRE 1552 -1456 1488 -1456
WIRE 1632 -1456 1552 -1456
WIRE 1232 -1440 1232 -1456
WIRE 1488 -1440 1488 -1456
WIRE 1488 -1360 1488 -1376
WIRE 1232 -1344 1232 -1360
WIRE -1920 -1120 -2000 -1120
WIRE -1856 -1120 -1920 -1120
WIRE -1824 -1120 -1856 -1120
WIRE -1920 -1104 -1920 -1120
WIRE -768 -1056 -848 -1056
WIRE -752 -1056 -768 -1056
WIRE -672 -1056 -752 -1056
WIRE -544 -1056 -592 -1056
WIRE -432 -1056 -464 -1056
WIRE -240 -1056 -352 -1056
WIRE -848 -1024 -848 -1056
WIRE -768 -1024 -768 -1056
WIRE -240 -1008 -240 -1056
WIRE -1920 -992 -1920 -1024
WIRE -1856 -928 -1920 -928
WIRE -1808 -928 -1856 -928
WIRE -848 -928 -848 -944
WIRE -768 -928 -768 -960
WIRE 464 -928 416 -928
WIRE 560 -928 464 -928
WIRE 1328 -928 1280 -928
WIRE 1424 -928 1328 -928
WIRE -1920 -912 -1920 -928
WIRE 416 -912 416 -928
WIRE 1280 -912 1280 -928
WIRE -1920 -816 -1920 -832
WIRE 416 -816 416 -832
WIRE 1280 -816 1280 -832
WIRE -784 -768 -912 -768
WIRE -1840 -752 -1920 -752
WIRE -1744 -752 -1840 -752
WIRE -656 -752 -704 -752
WIRE -608 -752 -656 -752
WIRE -1920 -736 -1920 -752
WIRE -912 -736 -912 -768
WIRE -704 -736 -704 -752
WIRE 1328 -736 1280 -736
WIRE 1424 -736 1328 -736
WIRE 464 -720 416 -720
WIRE 560 -720 464 -720
WIRE 1280 -720 1280 -736
WIRE 416 -704 416 -720
WIRE -1920 -640 -1920 -656
WIRE -704 -640 -704 -656
WIRE -912 -624 -912 -656
WIRE 1280 -624 1280 -640
WIRE 416 -608 416 -624
WIRE -608 -576 -704 -576
WIRE -464 -576 -608 -576
WIRE -1856 -560 -1920 -560
WIRE -1808 -560 -1856 -560
WIRE -704 -560 -704 -576
WIRE -1920 -544 -1920 -560
WIRE 464 -544 416 -544
WIRE 560 -544 464 -544
WIRE 1328 -544 1280 -544
WIRE 1424 -544 1328 -544
WIRE 416 -528 416 -544
WIRE 1280 -528 1280 -544
WIRE -704 -464 -704 -480
WIRE -1920 -448 -1920 -464
WIRE 416 -432 416 -448
WIRE 1280 -432 1280 -448
FLAG -2128 -2480 A_in
IOPIN -2128 -2480 BiDir
FLAG -1216 -2496 C_out
IOPIN -1216 -2496 BiDir
FLAG -1920 -992 0
FLAG -2000 -1120 Vc
IOPIN -2000 -1120 In
FLAG -2128 -2256 C_in
IOPIN -2128 -2256 BiDir
FLAG -1856 -1120 Vc
FLAG -1648 -2496 c_fly
FLAG -1968 -2480 a
FLAG -1856 -560 I_pk
FLAG -1920 -640 0
FLAG -1840 -752 I_Pk_min_mag
FLAG -1920 -448 0
FLAG -1920 -816 0
FLAG -1856 -928 I_pk_mag
FLAG -1264 -1680 0
FLAG -1184 -1792 Don_0
FLAG -1264 -1472 0
FLAG 1232 -1856 0
FLAG 1552 -1456 CCM
FLAG 1440 -1872 0
FLAG -592 -1680 0
FLAG -592 -1472 0
FLAG -544 -1584 Doff_1
FLAG 224 -1680 0
FLAG 528 -1792 Don_2
FLAG 432 -1696 0
FLAG 224 -1472 0
FLAG 528 -1584 Doff_2
FLAG 432 -1488 0
FLAG 416 -816 0
FLAG 464 -928 delta_I_demag
FLAG 1280 -624 0
FLAG 1328 -736 I_min_mag
FLAG 1280 -816 0
FLAG 1328 -928 delta_I_mag
FLAG 1280 -432 0
FLAG 1328 -544 I_mag
FLAG 416 -432 0
FLAG 464 -544 I_demag
FLAG 416 -608 0
FLAG 464 -720 I_min_demag
FLAG -1232 -1584 Doff_0
FLAG -752 -1056 CCM_Ind_V
FLAG -768 -928 0
FLAG -704 -640 0
FLAG -656 -752 Ind_V_raw
FLAG -1840 -1696 0
FLAG -1584 -1808 a_c
FLAG -1664 -1696 0
FLAG -912 -624 0
FLAG 1520 -1968 CCM_raw
FLAG -528 -1792 Don_1
FLAG -704 -464 0
FLAG -608 -576 Ind_V
FLAG -1840 -1472 0
FLAG -1568 -1584 f
FLAG -1664 -1472 0
FLAG 1232 -2048 0
FLAG 1248 -2160 CCM_test
FLAG 1968 -2064 0
FLAG 1984 -2176 CCM_test_2
FLAG 1232 -1344 0
FLAG 1280 -1696 tst1
FLAG 1232 -1584 0
FLAG 1824 -1696 tst2
FLAG 1776 -1584 0
FLAG 1488 -1360 0
FLAG -848 -928 0
FLAG -1216 -2256 A_out
IOPIN -1216 -2256 BiDir
FLAG -240 -1008 0
FLAG -1968 -2256 c
FLAG -1824 -2208 0
DATAFLAG -832 -768 ""
SYMBOL bi -1936 -2416 R0
WINDOW 0 -99 35 Left 2
WINDOW 3 -189 62 Left 2
SYMATTR InstName Bin
SYMATTR Value I=  V(I_mag)
SYMBOL res -1936 -1120 R0
SYMATTR InstName R3
SYMATTR Value 10Meg
SYMBOL res -2000 -2496 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R6
SYMATTR Value 1µ
SYMBOL bv -1920 -752 R0
WINDOW 3 49 63 Left 2
WINDOW 0 49 38 Left 2
SYMATTR Value V=  V(a_c) * {D_min / (Fs * L ) }
SYMATTR InstName B6
SYMBOL bv -1920 -560 R0
WINDOW 3 45 73 Left 2
WINDOW 0 42 44 Left 2
SYMATTR Value V=  max( V(I_pk_mag), V(I_pk_min_mag)  )
SYMATTR InstName B10
SYMBOL bv -1920 -928 R0
WINDOW 3 45 56 Left 2
WINDOW 0 43 32 Left 2
SYMATTR Value V=  ( V(Vc) - {SlopeAmp} * V(don_2) ) / {Ri}
SYMATTR InstName B26
SYMBOL bv -1264 -1792 R0
WINDOW 3 54 81 Left 2
WINDOW 0 52 49 Left 2
SYMATTR Value V = {Fs * L} * V(I_pk) / V(a_c)
SYMATTR InstName B21
SYMBOL bv -1264 -1584 R0
WINDOW 3 65 81 Left 2
WINDOW 0 58 41 Left 2
SYMATTR Value V = {Fs * L} * V(I_pk) / (V(f) + 1u)
SYMATTR InstName B11
SYMBOL bv 1232 -1968 R0
WINDOW 3 326 90 Left 2
WINDOW 0 323 60 Left 2
SYMATTR Value V= if(sync > 0.5, 2, if (  V(CCM_test)  > 1 , 2, 0  ) )
SYMATTR InstName B12
SYMBOL res 1408 -1984 R90
WINDOW 0 -3 55 VBottom 2
WINDOW 3 36 51 VTop 2
SYMATTR InstName R7
SYMATTR Value {100*R_lp}
SYMBOL cap 1424 -1952 R0
WINDOW 0 38 10 Left 2
WINDOW 3 40 36 Left 2
SYMATTR InstName C2
SYMATTR Value 10p
SYMBOL bv -592 -1792 R0
WINDOW 3 43 82 Left 2
WINDOW 0 46 49 Left 2
SYMATTR Value V= limit( V(f) / ( V(a_c) + V(f)  ), {D_min}, {D_max}  )
SYMATTR InstName B14
SYMBOL bv -592 -1584 R0
WINDOW 3 221 89 Right 2
WINDOW 0 54 54 Left 2
SYMATTR Value V=  1- V(Don_1)
SYMATTR InstName B15
SYMBOL bv 224 -1792 R0
WINDOW 3 -27 -76 Left 2
WINDOW 0 -20 -105 Left 2
SYMATTR Value V= limit(  if (  V(CCM)  > 1 , V(Don_1), V(Don_0)  ),  {D_min}, {D_max} )
SYMATTR InstName B16
SYMBOL res 400 -1808 R90
WINDOW 0 -3 55 VBottom 2
WINDOW 3 36 51 VTop 2
SYMATTR InstName R17
SYMATTR Value {1*R_lp}
SYMBOL cap 416 -1776 R0
WINDOW 0 38 10 Left 2
WINDOW 3 40 36 Left 2
SYMATTR InstName C10
SYMATTR Value 10p
SYMBOL bv 224 -1584 R0
WINDOW 3 -49 191 Left 2
WINDOW 0 -53 160 Left 2
SYMATTR Value V = if (  V(CCM) > 1 , V(Doff_1), V(Doff_0)  )
SYMATTR InstName B18
SYMBOL res 400 -1600 R90
WINDOW 0 -3 55 VBottom 2
WINDOW 3 36 51 VTop 2
SYMATTR InstName R18
SYMATTR Value {1*R_lp}
SYMBOL cap 416 -1568 R0
WINDOW 0 38 10 Left 2
WINDOW 3 40 36 Left 2
SYMATTR InstName C11
SYMATTR Value 10p
SYMBOL bv 416 -928 R0
WINDOW 3 46 83 Left 2
WINDOW 0 49 51 Left 2
SYMATTR Value V= V(f) * V(Doff_2) / {L * Fs}
SYMATTR InstName B23
SYMBOL bv 1280 -736 R0
WINDOW 3 44 73 Left 2
WINDOW 0 45 46 Left 2
SYMATTR Value V= V(I_pk) - V(delta_I_mag)
SYMATTR InstName B24
SYMBOL bv 1280 -928 R0
WINDOW 3 44 71 Left 2
WINDOW 0 42 45 Left 2
SYMATTR Value V= V(a_c) * V(Don_2) / {L * Fs}
SYMATTR InstName B25
SYMBOL bv 1280 -544 R0
WINDOW 3 42 80 Left 2
WINDOW 0 42 49 Left 2
SYMATTR Value V= ( V(I_min_mag) + V(delta_I_mag)/2  ) * V(Don_2)
SYMATTR InstName B28
SYMBOL bv 416 -544 R0
WINDOW 3 46 76 Left 2
WINDOW 0 47 54 Left 2
SYMATTR Value V= ( V(I_pk) - V(delta_I_demag)/2  ) * V(Doff_2)
SYMATTR InstName B29
SYMBOL bv 416 -720 R0
WINDOW 3 42 76 Left 2
WINDOW 0 47 49 Left 2
SYMATTR Value V= V(I_pk) - V(delta_I_mag)
SYMATTR InstName B30
SYMBOL cap -784 -1024 R0
WINDOW 0 61 21 Left 2
WINDOW 3 56 43 Left 2
SYMATTR InstName Cs1
SYMATTR Value { Cs }
SYMBOL res -448 -1072 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R2
SYMATTR Value 1m
SYMBOL ind -336 -1072 R90
WINDOW 0 5 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName L1
SYMATTR Value {L}
SYMBOL voltage -688 -1056 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 -32 56 VBottom 2
WINDOW 123 0 0 Left 2
WINDOW 39 0 0 Left 2
SYMATTR InstName Vccm
SYMATTR Value 0
SYMBOL bv -704 -752 R0
WINDOW 0 45 54 Left 2
WINDOW 3 43 81 Left 2
SYMATTR InstName B3
SYMATTR Value V= if( V(CCM) > 1, V(CCM_Ind_V), 0  )
SYMBOL bv -1840 -1808 R0
WINDOW 3 -40 82 Right 2
WINDOW 0 -86 56 Left 2
SYMATTR Value V=  V(a, c) - V(Ind_V)
SYMATTR InstName B5
SYMBOL res -1696 -1824 R90
WINDOW 0 -7 58 VBottom 2
WINDOW 3 32 58 VTop 2
SYMATTR InstName R11
SYMATTR Value {1 * R_lp}
SYMBOL cap -1680 -1776 R0
SYMATTR InstName C4
SYMATTR Value 10p
SYMBOL voltage -912 -752 R0
SYMATTR InstName V1
SYMATTR Value {Cs}
SYMBOL bv -704 -576 R0
WINDOW 0 49 36 Left 2
WINDOW 3 44 68 Left 2
SYMATTR InstName B4
SYMATTR Value V= limit( V(Ind_V_raw), -1*V(a), (V(a) - 1m) )
SYMBOL bv -1840 -1584 R0
WINDOW 3 -42 85 Right 2
WINDOW 0 -86 56 Left 2
SYMATTR Value V=  V(c_fly) + V(Ind_V)
SYMATTR InstName B20
SYMBOL res -1696 -1600 R90
WINDOW 0 -7 58 VBottom 2
WINDOW 3 32 58 VTop 2
SYMATTR InstName R13
SYMATTR Value {R_lp}
SYMBOL cap -1680 -1552 R0
SYMATTR InstName C8
SYMATTR Value 10p
SYMBOL bv 1232 -2160 R0
WINDOW 3 51 65 Left 2
WINDOW 0 54 36 Left 2
SYMATTR Value V= limit( V(Don_0) + V(Doff_0), 0, 2)
SYMATTR InstName B7
SYMBOL bv 1968 -2176 R0
WINDOW 3 60 86 Left 2
WINDOW 0 57 61 Left 2
SYMATTR Value V= limit( V(Doff_0) * (  1 + V(f) / V(a_c) ), 0, 2)
SYMATTR InstName B22
SYMBOL bv 1232 -1456 R0
WINDOW 3 350 61 Left 2
WINDOW 0 352 32 Left 2
SYMATTR Value V= if( V(CCM_test) > 1,  V(tst1), V(tst2) )
SYMATTR InstName B13
SYMBOL bv 1232 -1696 R0
WINDOW 3 62 77 Left 2
WINDOW 0 60 42 Left 2
SYMATTR Value V= if( V(CCM_raw) > 1.8, 2, 0 )
SYMATTR InstName B19
SYMBOL bv 1776 -1696 R0
WINDOW 3 63 83 Left 2
WINDOW 0 68 49 Left 2
SYMATTR Value V= if( V(CCM_raw) < 0.2, 0, 2 )
SYMATTR InstName B27
SYMBOL res 1424 -1472 R90
WINDOW 0 -3 55 VBottom 2
WINDOW 3 36 51 VTop 2
SYMATTR InstName R1
SYMATTR Value {10*R_lp}
SYMBOL cap 1472 -1440 R0
WINDOW 0 38 10 Left 2
WINDOW 3 40 36 Left 2
SYMATTR InstName C5
SYMATTR Value 10p
SYMBOL bi -848 -944 R180
WINDOW 0 233 53 Left 2
WINDOW 3 66 23 Left 2
SYMATTR InstName B32
SYMATTR Value I = V(I_min_mag)
SYMBOL bi -1824 -2336 R180
WINDOW 0 -100 17 Left 2
WINDOW 3 -26 -15 Right 2
SYMATTR InstName Bout
SYMATTR Value I=   V(I_demag)
SYMBOL voltage -1584 -2496 R270
WINDOW 0 34 103 VTop 2
WINDOW 3 29 105 VBottom 2
WINDOW 123 0 0 Left 2
WINDOW 39 0 0 Left 2
SYMATTR InstName Viso
SYMATTR Value 0
SYMBOL e -1408 -2464 M0
WINDOW 0 83 34 Left 2
WINDOW 3 41 63 Left 2
SYMATTR InstName E2
SYMATTR Value {1/N}
SYMBOL bi -1264 -2384 R180
WINDOW 0 -78 47 Left 2
WINDOW 3 -53 17 Right 2
SYMATTR InstName B1
SYMATTR Value I= I(Viso) / {N}
SYMBOL res -2000 -2272 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R4
SYMATTR Value 1µ
TEXT -320 -2544 Left 2 !.param R_lp = 10meg/Fs
TEXT -664 -2528 Left 2 !.param L = 10u
TEXT -664 -2560 Left 2 !.param Fs = 200k
TEXT -664 -2432 Left 2 !.param D_min = 5
TEXT -664 -2400 Left 2 !.param D_max = 90
TEXT -664 -2464 Left 2 !.param SlopeAmp =0.2
TEXT -664 -2496 Left 2 !.param Ri = 0.25
TEXT -664 -2592 Left 2 !.param sync = 0
TEXT 2016 16 Left 2 ;Drawn : Mark Dimattina
TEXT 2008 -72 Left 4 ;Title :  Flyback
TEXT 2016 80 Left 2 ;Rev: 0.01
TEXT 2016 48 Left 2 ;Date: 16/05/2024
TEXT 2016 112 Left 2 ;M.J.Dimattina@ieee.org
TEXT -320 -2512 Left 2 !.param Cs = { 1 / ( L * ( pi * Fs)**2 ) }
TEXT -1872 -608 Left 2 ;Peak Current
TEXT -1896 -2624 Left 6 ;Flyback
TEXT -1264 -2080 Left 2 ;V = L di/dt
TEXT -1264 -2048 Left 2 ;dt = L * di / V
TEXT 592 -936 Left 2 ;delta I   during demag
TEXT 976 -952 Left 2 ;di =V * dt /  L
TEXT 1456 -936 Left 2 ;delta I   during mag
TEXT 1456 -552 Left 2 ;Magentizing Current
TEXT 592 -552 Left 2 ;De-magentizing Current
TEXT -1312 -1848 Left 2 ;On Time Duty Cycle
TEXT -1312 -1632 Left 2 ;Off Time Duty Cycle
TEXT 1208 -2208 Left 2 ;When Don + Doff > 1
TEXT -648 -1896 Left 2 ;Don_1 = Don_0 / ( Don_0 + Doff_0 )
TEXT -640 -1848 Left 2 ;simplifies to ->
TEXT -1264 -1992 Left 5 ;DCM
TEXT -552 -2000 Left 5 ;CCM
TEXT -640 -2056 Left 2 ;V= limit( V(c_p) / ( V(a_c) + V(c_p)  ), {D_min}, {D_max} )
TEXT 312 -2016 Left 5 ;Mode Toggle
TEXT 1600 -2296 Left 5 ;Mode Selection
TEXT 808 -1104 Left 5 ;Current Calculation
TEXT -728 -1184 Left 5 ;CCM Inductor Voltage
TEXT -1904 -1224 Left 5 ;Peak Current
TEXT 1272 -1752 Left 2 ;Hysteresis to improve transient simulation speed
TEXT -664 -2624 Left 2 !.param N = 1
TEXT -1744 -2224 Left 2 ;I=  limit( V(I_demag), 0, 1meg)
TEXT 1216 -2408 Left 2 ;V= limit( V(Don_0) * (  1 + V(a_c) / V(c_p) ), 0, 2)
RECTANGLE Normal 2656 224 -2496 -2720 2
