Version 4
SHEET 1 3748 852
WIRE -1872 -2512 -1952 -2512
WIRE -1840 -2512 -1872 -2512
WIRE -1616 -2512 -1680 -2512
WIRE -1552 -2512 -1616 -2512
WIRE -1840 -2448 -1840 -2512
WIRE -1680 -2448 -1680 -2512
WIRE -1840 -2336 -1840 -2368
WIRE -1792 -2336 -1840 -2336
WIRE -1680 -2336 -1680 -2368
WIRE -1680 -2336 -1792 -2336
WIRE -1840 -2288 -1840 -2336
WIRE 2864 -2176 2848 -2176
WIRE 2928 -2176 2864 -2176
WIRE 1248 -2160 1232 -2160
WIRE 1312 -2160 1248 -2160
WIRE 2848 -2160 2848 -2176
WIRE 1232 -2144 1232 -2160
WIRE 2848 -2064 2848 -2080
WIRE 1232 -2048 1232 -2064
WIRE -1856 -1920 -1904 -1920
WIRE -1728 -1920 -1776 -1920
WIRE -1648 -1920 -1728 -1920
WIRE -1584 -1920 -1648 -1920
WIRE -1904 -1904 -1904 -1920
WIRE -1248 -1904 -1328 -1904
WIRE -1168 -1904 -1248 -1904
WIRE -592 -1904 -656 -1904
WIRE -512 -1904 -592 -1904
WIRE 272 -1904 192 -1904
WIRE 400 -1904 352 -1904
WIRE 496 -1904 400 -1904
WIRE 560 -1904 496 -1904
WIRE -1728 -1888 -1728 -1920
WIRE -1328 -1888 -1328 -1904
WIRE -656 -1888 -656 -1904
WIRE 192 -1888 192 -1904
WIRE 400 -1888 400 -1904
WIRE 1632 -1888 1232 -1888
WIRE 1760 -1888 1712 -1888
WIRE 1840 -1888 1760 -1888
WIRE 1920 -1888 1840 -1888
WIRE 1232 -1872 1232 -1888
WIRE 1760 -1872 1760 -1888
WIRE -1904 -1808 -1904 -1824
WIRE -1728 -1808 -1728 -1824
WIRE 400 -1808 400 -1824
WIRE -1328 -1792 -1328 -1808
WIRE -656 -1792 -656 -1808
WIRE 192 -1792 192 -1808
WIRE 1760 -1792 1760 -1808
WIRE 1232 -1776 1232 -1792
WIRE 1808 -1744 1760 -1744
WIRE 1872 -1744 1808 -1744
WIRE 1280 -1728 1232 -1728
WIRE 1328 -1728 1280 -1728
WIRE 1760 -1728 1760 -1744
WIRE 1232 -1712 1232 -1728
WIRE -1856 -1696 -1904 -1696
WIRE -1728 -1696 -1776 -1696
WIRE -1632 -1696 -1728 -1696
WIRE -1584 -1696 -1632 -1696
WIRE -1296 -1696 -1328 -1696
WIRE -1168 -1696 -1296 -1696
WIRE -608 -1696 -656 -1696
WIRE -528 -1696 -608 -1696
WIRE 272 -1696 192 -1696
WIRE 400 -1696 352 -1696
WIRE 496 -1696 400 -1696
WIRE 560 -1696 496 -1696
WIRE -1904 -1680 -1904 -1696
WIRE -1328 -1680 -1328 -1696
WIRE -656 -1680 -656 -1696
WIRE 192 -1680 192 -1696
WIRE 400 -1680 400 -1696
WIRE -1728 -1664 -1728 -1696
WIRE 1760 -1632 1760 -1648
WIRE 1232 -1616 1232 -1632
WIRE 400 -1600 400 -1616
WIRE -1904 -1584 -1904 -1600
WIRE -1728 -1584 -1728 -1600
WIRE -1328 -1584 -1328 -1600
WIRE -656 -1584 -656 -1600
WIRE 192 -1584 192 -1600
WIRE 1424 -1552 1232 -1552
WIRE 1568 -1552 1504 -1552
WIRE 1632 -1552 1568 -1552
WIRE 1712 -1552 1632 -1552
WIRE 1232 -1536 1232 -1552
WIRE 1568 -1536 1568 -1552
WIRE 1568 -1456 1568 -1472
WIRE 1232 -1440 1232 -1456
WIRE -1984 -1120 -2064 -1120
WIRE -1920 -1120 -1984 -1120
WIRE -1888 -1120 -1920 -1120
WIRE -1984 -1104 -1984 -1120
WIRE -800 -1088 -880 -1088
WIRE -784 -1088 -800 -1088
WIRE -592 -1088 -784 -1088
WIRE -464 -1088 -512 -1088
WIRE -352 -1088 -384 -1088
WIRE -208 -1088 -272 -1088
WIRE 432 -1072 384 -1072
WIRE 528 -1072 432 -1072
WIRE 1008 -1072 960 -1072
WIRE 1104 -1072 1008 -1072
WIRE -880 -1056 -880 -1088
WIRE -800 -1056 -800 -1088
WIRE 384 -1056 384 -1072
WIRE 960 -1056 960 -1072
WIRE -208 -1024 -208 -1088
WIRE -1984 -992 -1984 -1024
WIRE 384 -960 384 -976
WIRE 960 -960 960 -976
WIRE -1920 -928 -1984 -928
WIRE -1872 -928 -1920 -928
WIRE -880 -928 -880 -976
WIRE -800 -928 -800 -992
WIRE -1984 -912 -1984 -928
WIRE 2912 -896 2864 -896
WIRE 3008 -896 2912 -896
WIRE 432 -880 384 -880
WIRE 528 -880 432 -880
WIRE 2864 -880 2864 -896
WIRE 384 -864 384 -880
WIRE -1984 -816 -1984 -832
WIRE -768 -800 -896 -800
WIRE -640 -784 -688 -784
WIRE -592 -784 -640 -784
WIRE 2864 -784 2864 -800
WIRE -896 -768 -896 -800
WIRE -688 -768 -688 -784
WIRE 384 -768 384 -784
WIRE -1904 -752 -1984 -752
WIRE -1808 -752 -1904 -752
WIRE -1984 -736 -1984 -752
WIRE 432 -688 384 -688
WIRE 528 -688 432 -688
WIRE 2912 -688 2864 -688
WIRE 3008 -688 2912 -688
WIRE -688 -672 -688 -688
WIRE 384 -672 384 -688
WIRE 2864 -672 2864 -688
WIRE -896 -656 -896 -688
WIRE -1984 -640 -1984 -656
WIRE -592 -608 -688 -608
WIRE -448 -608 -592 -608
WIRE -688 -592 -688 -608
WIRE 384 -576 384 -592
WIRE 2864 -576 2864 -592
WIRE -1920 -560 -1984 -560
WIRE -1872 -560 -1920 -560
WIRE -1984 -544 -1984 -560
WIRE -688 -496 -688 -512
WIRE -1984 -448 -1984 -464
FLAG -1952 -2512 A
IOPIN -1952 -2512 BiDir
FLAG -1792 -2336 p
FLAG -1552 -2512 C
IOPIN -1552 -2512 BiDir
FLAG -1984 -992 0
FLAG -2064 -1120 Vc
IOPIN -2064 -1120 In
FLAG -1840 -2288 P
IOPIN -1840 -2288 BiDir
FLAG -1920 -1120 Vc
FLAG -1616 -2512 c
FLAG -1872 -2512 a
FLAG -1920 -560 I_pk
FLAG -1984 -640 0
FLAG -1904 -752 I_Pk_min
FLAG -1984 -448 0
FLAG -1984 -816 0
FLAG -1920 -928 I_pk_raw
FLAG -1328 -1792 0
FLAG -1248 -1904 Don_0
FLAG -1328 -1584 0
FLAG 1232 -1776 0
FLAG 1632 -1552 CCM
FLAG 1760 -1792 0
FLAG -656 -1792 0
FLAG -656 -1584 0
FLAG -608 -1696 Doff_1
FLAG 192 -1792 0
FLAG 496 -1904 Don_2
FLAG 400 -1808 0
FLAG 192 -1584 0
FLAG 496 -1696 Doff_2
FLAG 400 -1600 0
FLAG 2864 -784 0
FLAG 2912 -896 delta_I_demag
FLAG 960 -960 0
FLAG 1008 -1072 I_min_mag
FLAG 384 -960 0
FLAG 432 -1072 delta_I_mag
FLAG 384 -768 0
FLAG 432 -880 I_mag
FLAG 384 -576 0
FLAG 432 -688 I_demag
FLAG 2864 -576 0
FLAG 2912 -688 I_min_demag
FLAG -1296 -1696 Doff_0
FLAG -784 -1088 CCM_Ind_V
FLAG -688 -672 0
FLAG -640 -784 Ind_V_raw
FLAG -1904 -1808 0
FLAG -1648 -1920 mag
FLAG -1728 -1808 0
FLAG -896 -656 0
FLAG 1840 -1888 CCM_raw
FLAG -592 -1904 Don_1
FLAG -688 -496 0
FLAG -592 -608 Ind_V
FLAG -1904 -1584 0
FLAG -1632 -1696 demag
FLAG -1728 -1584 0
FLAG 1232 -2048 0
FLAG 1248 -2160 CCM_test
FLAG 2848 -2064 0
FLAG 2864 -2176 CCM_test_2
FLAG 1232 -1440 0
FLAG 1280 -1728 tst1
FLAG 1232 -1616 0
FLAG 1808 -1744 tst2
FLAG 1760 -1632 0
FLAG 1568 -1456 0
FLAG -880 -928 0
FLAG -800 -928 0
FLAG -208 -1024 0
DATAFLAG -816 -800 ""
SYMBOL bi -1840 -2448 R0
WINDOW 0 -99 35 Left 2
WINDOW 3 -209 85 Left 2
SYMATTR InstName Bin
SYMATTR Value I=  V(I_mag)
SYMBOL res -2000 -1120 R0
SYMATTR InstName R3
SYMATTR Value 10Meg
SYMBOL bv -1984 -752 R0
WINDOW 3 49 63 Left 2
WINDOW 0 49 38 Left 2
SYMATTR Value V=  V(mag) * {D_min / (Fs * L ) }
SYMATTR InstName B6
SYMBOL bv -1984 -560 R0
WINDOW 3 45 73 Left 2
WINDOW 0 42 44 Left 2
SYMATTR Value V=  max( V(I_pk_raw), V(I_pk_min)  )
SYMATTR InstName B10
SYMBOL bv -1984 -928 R0
WINDOW 3 45 56 Left 2
WINDOW 0 43 32 Left 2
SYMATTR Value V=  ( V(Vc) - {SlopeAmp} * V(don_2) ) / {Ri}
SYMATTR InstName B26
SYMBOL bv -1328 -1904 R0
WINDOW 3 54 81 Left 2
WINDOW 0 52 49 Left 2
SYMATTR Value V = {Fs * L} * V(I_pk) / V(mag)
SYMATTR InstName B21
SYMBOL bv -1328 -1696 R0
WINDOW 3 65 81 Left 2
WINDOW 0 58 41 Left 2
SYMATTR Value V = {Fs * L} * V(I_pk) / (V(demag) + 1u)
SYMATTR InstName B11
SYMBOL bv 1232 -1888 R0
WINDOW 3 53 99 Left 2
WINDOW 0 50 64 Left 2
SYMATTR Value V= if (  V(CCM_test)  > 1 , 2, 0  )
SYMATTR InstName B12
SYMBOL res 1728 -1904 R90
WINDOW 0 -3 55 VBottom 2
WINDOW 3 36 51 VTop 2
SYMATTR InstName R7
SYMATTR Value {100*R_lp}
SYMBOL cap 1744 -1872 R0
WINDOW 0 38 10 Left 2
WINDOW 3 40 36 Left 2
SYMATTR InstName C2
SYMATTR Value 10p
SYMBOL bv -656 -1904 R0
WINDOW 3 -73 -49 Left 2
WINDOW 0 46 49 Left 2
SYMATTR Value V= limit( V(demag) / ( V(mag) + V(demag)  ), {D_min}, {D_max} )
SYMATTR InstName B14
SYMBOL bv -656 -1696 R0
WINDOW 3 221 89 Right 2
WINDOW 0 54 54 Left 2
SYMATTR Value V=  1- V(Don_1)
SYMATTR InstName B15
SYMBOL bv 192 -1904 R0
WINDOW 3 -27 -76 Left 2
WINDOW 0 -20 -105 Left 2
SYMATTR Value V= limit(  if (  V(CCM)  > 1 , V(Don_1), V(Don_0)  ),  {D_min}, {D_max} )
SYMATTR InstName B16
SYMBOL res 368 -1920 R90
WINDOW 0 -3 55 VBottom 2
WINDOW 3 36 51 VTop 2
SYMATTR InstName R17
SYMATTR Value {1*R_lp}
SYMBOL cap 384 -1888 R0
WINDOW 0 38 10 Left 2
WINDOW 3 40 36 Left 2
SYMATTR InstName C10
SYMATTR Value 10p
SYMBOL bv 192 -1696 R0
WINDOW 3 -49 191 Left 2
WINDOW 0 -53 160 Left 2
SYMATTR Value V = if (  V(CCM) > 1 , V(Doff_1), V(Doff_0)  )
SYMATTR InstName B18
SYMBOL res 368 -1712 R90
WINDOW 0 -3 55 VBottom 2
WINDOW 3 36 51 VTop 2
SYMATTR InstName R18
SYMATTR Value {1*R_lp}
SYMBOL cap 384 -1680 R0
WINDOW 0 38 10 Left 2
WINDOW 3 40 36 Left 2
SYMATTR InstName C11
SYMATTR Value 10p
SYMBOL bv 2864 -896 R0
WINDOW 3 46 83 Left 2
WINDOW 0 49 51 Left 2
SYMATTR Value V= V(demag) * V(Doff_2) / {L * Fs}
SYMATTR InstName B23
SYMBOL bv 960 -1072 R0
WINDOW 3 44 73 Left 2
WINDOW 0 45 46 Left 2
SYMATTR Value V= V(I_pk) - V(delta_I_mag)
SYMATTR InstName B24
SYMBOL bv 384 -1072 R0
WINDOW 3 44 71 Left 2
WINDOW 0 42 45 Left 2
SYMATTR Value V= V(mag) * V(Don_2) / {L * Fs}
SYMATTR InstName B25
SYMBOL bv 384 -880 R0
WINDOW 3 42 80 Left 2
WINDOW 0 42 49 Left 2
SYMATTR Value V= ( V(I_min_mag) + V(delta_I_mag)/2  ) * V(Don_2)
SYMATTR InstName B28
SYMBOL bv 384 -688 R0
WINDOW 3 46 76 Left 2
WINDOW 0 47 54 Left 2
SYMATTR Value V= ( V(I_pk) - V(delta_I_mag)/2  ) * V(Doff_2)
SYMATTR InstName B29
SYMBOL bv 2864 -688 R0
WINDOW 3 42 76 Left 2
WINDOW 0 47 49 Left 2
SYMATTR Value V= V(I_pk) - V(delta_I_mag)
SYMATTR InstName B30
SYMBOL cap -816 -1056 R0
WINDOW 0 61 21 Left 2
WINDOW 3 56 43 Left 2
SYMATTR InstName Cs1
SYMATTR Value { Cs }
SYMBOL res -368 -1104 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R2
SYMATTR Value 1µ
SYMBOL ind -256 -1104 R90
WINDOW 0 5 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName L1
SYMATTR Value {L}
SYMATTR SpiceLine Rser=10u
SYMBOL voltage -608 -1088 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 -32 56 VBottom 2
WINDOW 123 0 0 Left 2
WINDOW 39 0 0 Left 2
SYMATTR InstName Vccm
SYMATTR Value 0
SYMBOL bv -688 -784 R0
WINDOW 0 45 54 Left 2
WINDOW 3 43 81 Left 2
SYMATTR InstName B3
SYMATTR Value V= if( V(CCM) > 1, V(CCM_Ind_V), 0  )
SYMBOL bv -1904 -1920 R0
WINDOW 3 -40 82 Right 2
WINDOW 0 -86 56 Left 2
SYMATTR Value V=  V(a, c) - V(Ind_V)
SYMATTR InstName B5
SYMBOL res -1760 -1936 R90
WINDOW 0 -7 58 VBottom 2
WINDOW 3 32 58 VTop 2
SYMATTR InstName R11
SYMATTR Value {1 * R_lp}
SYMBOL cap -1744 -1888 R0
SYMATTR InstName C4
SYMATTR Value 10p
SYMBOL voltage -896 -784 R0
SYMATTR InstName V1
SYMATTR Value {Cs}
SYMBOL bv -688 -608 R0
WINDOW 0 49 36 Left 2
WINDOW 3 44 68 Left 2
SYMATTR InstName B4
SYMATTR Value V= limit( V(Ind_V_raw), -V(a), (V(a) - 1m) )
SYMBOL bv -1904 -1696 R0
WINDOW 3 -42 85 Right 2
WINDOW 0 -86 56 Left 2
SYMATTR Value V=  V(c, p) + V(Ind_V)
SYMATTR InstName B20
SYMBOL res -1760 -1712 R90
WINDOW 0 -7 58 VBottom 2
WINDOW 3 32 58 VTop 2
SYMATTR InstName R13
SYMATTR Value {R_lp}
SYMBOL cap -1744 -1664 R0
SYMATTR InstName C8
SYMATTR Value 10p
SYMBOL bv 1232 -2160 R0
WINDOW 3 51 65 Left 2
WINDOW 0 54 36 Left 2
SYMATTR Value V= limit( V(Don_0) + V(Doff_0), 0, 2)
SYMATTR InstName B7
SYMBOL bv 2848 -2176 R0
WINDOW 3 60 86 Left 2
WINDOW 0 57 61 Left 2
SYMATTR Value V= limit( V(Doff_0) * (  1 + V(demag) / V(mag) ), 0, 2)
SYMATTR InstName B22
SYMBOL bv 1232 -1552 R0
WINDOW 3 53 148 Left 2
WINDOW 0 54 106 Left 2
SYMATTR Value V= if( sync > 0.5, 2, if( V(CCM_test) > 1,  V(tst1), V(tst2) )  )
SYMATTR InstName B13
SYMBOL bv 1232 -1728 R0
WINDOW 3 62 77 Left 2
WINDOW 0 60 42 Left 2
SYMATTR Value V= if( V(CCM_raw) > 1.8, 2, 0 )
SYMATTR InstName B19
SYMBOL bv 1760 -1744 R0
WINDOW 3 63 83 Left 2
WINDOW 0 68 49 Left 2
SYMATTR Value V= if( V(CCM_raw) < 0.2, 0, 2 )
SYMATTR InstName B27
SYMBOL res 1520 -1568 R90
WINDOW 0 -3 55 VBottom 2
WINDOW 3 36 51 VTop 2
SYMATTR InstName R1
SYMATTR Value {10*R_lp}
SYMBOL cap 1552 -1536 R0
WINDOW 0 38 10 Left 2
WINDOW 3 40 36 Left 2
SYMATTR InstName C5
SYMATTR Value 10p
SYMBOL bi -880 -976 R180
WINDOW 0 24 80 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName B32
SYMATTR Value I = V(I_min_mag)
SYMBOL bi -1680 -2368 R180
WINDOW 0 -120 51 Left 2
WINDOW 3 -409 24 Left 2
SYMATTR InstName Bout
SYMATTR Value I=  V(I_mag) + V(I_demag)
TEXT -40 -2560 Left 2 !.param R_lp = 10meg/Fs
TEXT -632 -2568 Left 2 !.param L = 10u
TEXT -632 -2600 Left 2 !.param Fs = 200k
TEXT -632 -2472 Left 2 !.param D_min = 0.05
TEXT -632 -2440 Left 2 !.param D_max = 0.90
TEXT -632 -2504 Left 2 !.param SlopeAmp =0.2
TEXT -632 -2536 Left 2 !.param Ri = 0.25
TEXT -632 -2632 Left 2 !.param sync = 0
TEXT 1760 -712 Left 2 ;Drawn : Mark Dimattina
TEXT 1752 -800 Left 4 ;Title : Buck-CM3
TEXT 1760 -648 Left 2 ;Rev: 0.01
TEXT 1760 -680 Left 2 ;Date: 22/05/2024
TEXT 1760 -616 Left 2 ;M.J.Dimattina@ieee.org
TEXT -40 -2528 Left 2 !.param Cs = { 1 / ( L * ( pi * Fs)**2 ) }
TEXT -1936 -608 Left 2 ;Peak Current
TEXT -1856 -2616 Left 6 ;Buck
TEXT -1328 -2192 Left 2 ;V = L di/dt
TEXT -1328 -2160 Left 2 ;dt = L * di / V
TEXT 3040 -904 Left 2 ;delta I   during demag
TEXT 376 -1136 Left 2 ;di =V * dt /  L
TEXT 560 -1080 Left 2 ;delta I   during mag
TEXT 560 -888 Left 2 ;Magentizing Current
TEXT 560 -696 Left 2 ;De-magentizing Current
TEXT -1376 -1960 Left 2 ;On Time Duty Cycle
TEXT -1376 -1744 Left 2 ;Off Time Duty Cycle
TEXT 1208 -2208 Left 2 ;When Don + Doff > 1
TEXT -704 -2056 Left 2 ;Don_1 = Don_0 / ( Don_0 + Doff_0 )
TEXT -696 -2008 Left 2 ;simplifies to ->
TEXT -1328 -2104 Left 5 ;DCM
TEXT -616 -2112 Left 5 ;CCM
TEXT 280 -2128 Left 5 ;Mode Toggle
TEXT 1600 -2296 Left 5 ;Mode Selection
TEXT 344 -1216 Left 5 ;Current Calculation
TEXT -824 -1208 Left 5 ;Induced Inductor Voltage
TEXT -1968 -1224 Left 5 ;Peak Current
TEXT 1280 -1952 Left 2 ;Hysteresis to improve transient simulation speed
TEXT 2912 -2040 Left 2 ;V= limit( V(Don_0) * (  1 + V(a_c) / V(c_p) ), 0, 2)
TEXT -2056 -2096 Left 5 ;Inductor Voltage
TEXT -2056 -2152 Left 5 ;Mag / Demag
RECTANGLE Normal 2336 -368 -2240 -2720 2
