Version 4
SHEET 1 1400 852
WIRE -480 -2112 -592 -2112
WIRE -432 -2112 -480 -2112
WIRE -1808 -2096 -1856 -2096
WIRE -1680 -2096 -1728 -2096
WIRE -1616 -2096 -1680 -2096
WIRE -1536 -2096 -1616 -2096
WIRE -592 -2096 -592 -2112
WIRE -1856 -2080 -1856 -2096
WIRE -1680 -2064 -1680 -2096
WIRE -592 -2000 -592 -2016
WIRE -1856 -1984 -1856 -2000
WIRE -1680 -1984 -1680 -2000
WIRE -560 -1936 -608 -1936
WIRE -432 -1936 -480 -1936
WIRE -384 -1936 -432 -1936
WIRE -352 -1936 -384 -1936
WIRE -608 -1920 -608 -1936
WIRE -432 -1920 -432 -1936
WIRE -1808 -1904 -1856 -1904
WIRE -1680 -1904 -1728 -1904
WIRE -1616 -1904 -1680 -1904
WIRE -1536 -1904 -1616 -1904
WIRE -1856 -1888 -1856 -1904
WIRE -1680 -1872 -1680 -1904
WIRE -432 -1840 -432 -1856
WIRE -608 -1824 -608 -1840
WIRE -1856 -1792 -1856 -1808
WIRE -1680 -1792 -1680 -1808
WIRE 640 -1792 512 -1792
WIRE 512 -1760 512 -1792
WIRE -512 -1728 -608 -1728
WIRE -464 -1728 -512 -1728
WIRE -2800 -1712 -2832 -1712
WIRE -2784 -1712 -2800 -1712
WIRE -1808 -1712 -1856 -1712
WIRE -1728 -1712 -1808 -1712
WIRE -608 -1712 -608 -1728
WIRE -2832 -1696 -2832 -1712
WIRE -1856 -1696 -1856 -1712
WIRE 512 -1648 512 -1680
WIRE -608 -1616 -608 -1632
WIRE -2832 -1600 -2832 -1616
WIRE -1856 -1600 -1856 -1616
WIRE -576 -1568 -608 -1568
WIRE -560 -1568 -576 -1568
WIRE -608 -1552 -608 -1568
WIRE -1808 -1520 -1856 -1520
WIRE -1728 -1520 -1808 -1520
WIRE -1856 -1504 -1856 -1520
WIRE -608 -1456 -608 -1472
WIRE -1856 -1408 -1856 -1424
WIRE -544 -1408 -608 -1408
WIRE -464 -1408 -544 -1408
WIRE -608 -1392 -608 -1408
WIRE -1808 -1344 -1856 -1344
WIRE -1728 -1344 -1808 -1344
WIRE -1856 -1328 -1856 -1344
WIRE -608 -1296 -608 -1312
WIRE -512 -1264 -608 -1264
WIRE -416 -1264 -512 -1264
WIRE -608 -1248 -608 -1264
WIRE -1856 -1232 -1856 -1248
WIRE -608 -1152 -608 -1168
WIRE -368 -1008 -608 -1008
WIRE -352 -1008 -368 -1008
WIRE -272 -1008 -352 -1008
WIRE -96 -1008 -192 -1008
WIRE -2000 -992 -2032 -992
WIRE -1856 -992 -1920 -992
WIRE -1824 -992 -1856 -992
WIRE -896 -960 -992 -960
WIRE -768 -960 -816 -960
WIRE -688 -960 -768 -960
WIRE -656 -960 -688 -960
WIRE -992 -944 -992 -960
WIRE -608 -944 -608 -1008
WIRE -656 -928 -656 -960
WIRE -768 -912 -768 -960
WIRE -224 -880 -288 -880
WIRE -96 -880 -144 -880
WIRE 0 -880 -96 -880
WIRE 80 -880 0 -880
WIRE -1824 -864 -1824 -992
WIRE -288 -864 -288 -880
WIRE -96 -864 -96 -880
WIRE -992 -832 -992 -864
WIRE -768 -832 -768 -848
WIRE -656 -832 -656 -880
WIRE -2192 -816 -2240 -816
WIRE -2080 -816 -2112 -816
WIRE -2016 -816 -2080 -816
WIRE -1984 -816 -2016 -816
WIRE -2080 -800 -2080 -816
WIRE -96 -784 -96 -800
WIRE -288 -768 -288 -784
WIRE -1824 -736 -1824 -784
WIRE -1264 -736 -1824 -736
WIRE -608 -736 -608 -864
WIRE -608 -736 -1264 -736
WIRE -608 -704 -608 -736
WIRE -2080 -688 -2080 -720
WIRE -2016 -624 -2080 -624
WIRE -1968 -624 -2016 -624
WIRE -224 -624 -288 -624
WIRE -96 -624 -144 -624
WIRE -16 -624 -96 -624
WIRE 48 -624 -16 -624
WIRE -2080 -608 -2080 -624
WIRE -288 -608 -288 -624
WIRE -96 -608 -96 -624
WIRE -608 -592 -608 -624
WIRE -96 -528 -96 -544
WIRE -2080 -512 -2080 -528
WIRE -288 -512 -288 -528
WIRE -2000 -448 -2080 -448
WIRE -1904 -448 -2000 -448
WIRE -2080 -432 -2080 -448
WIRE -1200 -368 -1232 -368
WIRE -1168 -368 -1200 -368
WIRE -1040 -368 -1168 -368
WIRE -912 -368 -992 -368
WIRE -896 -368 -912 -368
WIRE -816 -368 -896 -368
WIRE -688 -368 -736 -368
WIRE -576 -368 -608 -368
WIRE -432 -368 -496 -368
WIRE -192 -368 -288 -368
WIRE -64 -368 -112 -368
WIRE -16 -368 -64 -368
WIRE 32 -368 -16 -368
WIRE -992 -352 -992 -368
WIRE -432 -352 -432 -368
WIRE -288 -352 -288 -368
WIRE -64 -352 -64 -368
WIRE -2080 -336 -2080 -352
WIRE -1232 -336 -1232 -368
WIRE -1040 -336 -1040 -368
WIRE -912 -336 -912 -368
WIRE -352 -336 -352 -1008
WIRE -352 -336 -384 -336
WIRE -2016 -272 -2080 -272
WIRE -1952 -272 -2016 -272
WIRE -64 -272 -64 -288
WIRE -2080 -256 -2080 -272
WIRE -432 -256 -432 -272
WIRE -384 -256 -384 -288
WIRE -384 -256 -432 -256
WIRE -288 -256 -288 -272
WIRE -1232 -240 -1232 -256
WIRE -1040 -240 -1040 -288
WIRE -992 -240 -992 -272
WIRE -912 -240 -912 -272
WIRE -432 -224 -432 -256
WIRE -2080 -160 -2080 -176
WIRE -1168 -112 -1168 -368
WIRE -1040 -112 -1168 -112
WIRE -896 -112 -992 -112
WIRE -816 -112 -896 -112
WIRE -656 -112 -736 -112
WIRE -432 -112 -576 -112
WIRE -2032 -96 -2080 -96
WIRE -1936 -96 -2032 -96
WIRE -992 -96 -992 -112
WIRE -432 -96 -432 -112
WIRE -2080 -80 -2080 -96
WIRE -1040 -80 -1040 -112
WIRE -352 -80 -352 -336
WIRE -352 -80 -384 -80
WIRE -432 0 -432 -16
WIRE -384 0 -384 -32
WIRE -384 0 -432 0
WIRE -2080 16 -2080 0
WIRE -1040 16 -1040 -32
WIRE -992 16 -992 -16
WIRE -432 32 -432 0
WIRE -2016 80 -2080 80
WIRE -1920 80 -2016 80
WIRE -2080 112 -2080 80
WIRE -2080 208 -2080 192
FLAG -592 -2000 0
FLAG -480 -2112 dcx
FLAG -384 -1936 dc
FLAG -576 -1568 d2x
FLAG -544 -1408 d2_fw
FLAG -2032 -992 CM_a
IOPIN -2032 -992 BiDir
FLAG -1264 -736 p
FLAG -896 -368 c_CCM
FLAG -96 -1008 CM_c
IOPIN -96 -1008 BiDir
FLAG -288 -768 0
FLAG -16 -624 mode_det
FLAG -608 -1824 0
FLAG -608 -1616 0
FLAG -512 -1728 d_off
FLAG -608 -1296 0
FLAG -2080 -688 0
FLAG -2240 -816 CM_Vc
IOPIN -2240 -816 In
FLAG -608 -592 CM_p
IOPIN -608 -592 BiDir
FLAG -2016 -816 Vc
FLAG -368 -1008 c
FLAG -1856 -992 a
FLAG -432 -1840 0
FLAG -96 -528 0
FLAG -1232 -240 0
FLAG -1200 -368 I_pc_raw
FLAG -2080 16 0
FLAG -2032 -96 delta_I
FLAG -1856 -1232 0
FLAG -1808 -1344 a_c_lim
FLAG -608 -1456 0
FLAG -2016 -272 I_pk
FLAG -1856 -1792 0
FLAG -1616 -1904 a_c
FLAG -1680 -1792 0
FLAG -1856 -1984 0
FLAG -1616 -2096 c_p
FLAG -1680 -1984 0
FLAG -608 -1152 0
FLAG -512 -1264 d2
FLAG 0 -880 mode_det_raw
FLAG -288 -512 0
FLAG 512 -1648 0
FLAG -1856 -1600 0
FLAG -1808 -1712 a_c_mag
FLAG -1856 -1408 0
FLAG -1808 -1520 a_c_sign
FLAG -2080 -336 0
FLAG -2000 -448 I_Pk_min_mag
FLAG -2080 -160 0
FLAG -2080 -512 0
FLAG -2016 -624 I_pk_mag
FLAG -288 -256 0
FLAG -16 -368 cx
FLAG -992 -240 0
FLAG -432 -224 0
FLAG -64 -272 0
FLAG -992 -832 0
FLAG -688 -960 I_pc
FLAG -768 -832 0
FLAG -96 -784 0
FLAG -656 -832 0
FLAG -1040 -240 0
FLAG -912 -240 0
FLAG -896 -112 c_DCM
FLAG -992 16 0
FLAG -432 32 0
FLAG -1040 16 0
FLAG -2080 208 0
FLAG -2016 80 I_pc_mag
FLAG -2832 -1600 0
FLAG -2800 -1712 d2x_alt
DATAFLAG 592 -1792 ""
SYMBOL bv -592 -2112 R0
WINDOW 3 -56 86 Right 2
WINDOW 0 -170 54 Left 2
SYMATTR Value V=V(d2) * V(c_p)  / V(a_c_lim)
SYMATTR InstName Bdc_pwm
SYMBOL bi -1824 -864 R0
WINDOW 0 -99 35 Left 2
WINDOW 3 41 56 Left 2
SYMATTR InstName BIap
SYMATTR Value I= ( V(dc) / ( V(dc) + V(d2) )  ) * V(I_pc)
SYMBOL bv -288 -880 R0
WINDOW 3 36 141 Left 2
WINDOW 0 32 114 Left 2
SYMATTR Value V = 2 * {L} * {Fs} * V(I_pc)  / ( V(dc) *  V(a_c_lim) )
SYMATTR InstName B1
SYMBOL bv -608 -1936 R0
WINDOW 0 -170 49 Left 2
WINDOW 3 -46 73 Right 2
SYMATTR InstName Bdc_limit
SYMATTR Value V= limit( V(dcx), {D_min}, {D_max} )
SYMBOL bv -608 -1728 R0
WINDOW 0 -139 49 Left 2
WINDOW 3 -173 80 Left 2
SYMATTR InstName B_d_off
SYMATTR Value V= 1- V(dc)
SYMBOL bv -608 -1408 R0
WINDOW 0 -164 50 Left 2
WINDOW 3 -40 82 Right 2
SYMATTR InstName Bdc_limit2
SYMATTR Value V= limit( V(d2x), 1m, V(d_off)  )
SYMBOL res -2096 -816 R0
SYMATTR InstName R3
SYMATTR Value 10Meg
SYMBOL res -2096 -832 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R1
SYMATTR Value 1µ
SYMBOL res -624 -720 R0
SYMATTR InstName R4
SYMATTR Value 1µ
SYMBOL res -176 -1024 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R5
SYMATTR Value 1µ
SYMBOL res -1904 -1008 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R6
SYMATTR Value 1µ
SYMBOL res -464 -1952 R90
WINDOW 0 -3 55 VBottom 2
WINDOW 3 36 51 VTop 2
SYMATTR InstName R8
SYMATTR Value {10*R_lp}
SYMBOL cap -448 -1920 R0
WINDOW 0 38 10 Left 2
WINDOW 3 40 36 Left 2
SYMATTR InstName C5
SYMATTR Value 10p
SYMBOL res -128 -640 R90
WINDOW 0 60 73 VBottom 2
WINDOW 3 64 64 VTop 2
SYMATTR InstName R13
SYMATTR Value {10*R_lp}
SYMBOL cap -112 -608 R0
WINDOW 0 54 12 Left 2
WINDOW 3 52 35 Left 2
SYMATTR InstName C12
SYMATTR Value 10p
SYMBOL bv -1232 -352 R0
WINDOW 3 -36 80 Right 2
WINDOW 0 -86 56 Left 2
SYMATTR Value V= V(a_c_sign) * V(I_pc_mag)
SYMATTR InstName B8
SYMBOL bv -2080 -96 R0
WINDOW 3 68 59 Left 2
WINDOW 0 -80 49 Left 2
SYMATTR Value V=  ( abs( V(c_p) ) / {L} ) * V(d2) * {1/Fs} * ( 1 - ( V(dc) + V(d2) ) / 2 )
SYMATTR InstName B9
SYMBOL bv -1856 -1344 R0
WINDOW 0 -81 36 Left 2
WINDOW 3 -49 61 Right 2
SYMATTR InstName B5
SYMATTR Value V= V(a_c_mag) * V(a_c_sign)
SYMBOL bv -608 -1568 R0
WINDOW 0 -101 57 Left 2
WINDOW 3 -40 87 Right 2
SYMATTR InstName Bd
SYMATTR Value V = ( V(I_pk) * {L*Fs} ) / ( abs(V(c_p)) + 1u )
SYMBOL bv -1856 -1904 R0
WINDOW 3 -40 82 Right 2
WINDOW 0 -86 56 Left 2
SYMATTR Value V=  V(a, cx)
SYMATTR InstName B17
SYMBOL res -1712 -1920 R90
WINDOW 0 -7 58 VBottom 2
WINDOW 3 32 58 VTop 2
SYMATTR InstName R11
SYMATTR Value {R_lp}
SYMBOL cap -1696 -1872 R0
SYMATTR InstName C7
SYMATTR Value 10p
SYMBOL bv -1856 -2096 R0
WINDOW 3 -42 85 Right 2
WINDOW 0 -86 56 Left 2
SYMATTR Value V=  V(cx, p)
SYMATTR InstName B19
SYMBOL res -1712 -2112 R90
WINDOW 0 -7 58 VBottom 2
WINDOW 3 32 58 VTop 2
SYMATTR InstName R12
SYMATTR Value {R_lp}
SYMBOL cap -1696 -2064 R0
SYMATTR InstName C8
SYMATTR Value 10p
SYMBOL bv -608 -1264 R0
WINDOW 0 -92 51 Left 2
WINDOW 3 -31 83 Right 2
SYMATTR InstName B20
SYMATTR Value V= if( {sync} > 0.5, V(d_off), V(d2_fw) )
SYMBOL bv -288 -624 R0
WINDOW 3 34 150 Left 2
WINDOW 0 33 122 Left 2
SYMATTR Value V= limit( V(mode_det_raw), 0, 2)
SYMATTR InstName B7
SYMBOL voltage 512 -1776 R0
SYMATTR InstName V1
SYMATTR Value {Cs}
SYMBOL bv -1856 -1712 R0
WINDOW 0 -88 30 Left 2
WINDOW 3 -46 61 Right 2
SYMATTR InstName B13
SYMATTR Value V= max( abs( V(a_c) ), 1m )
SYMBOL bv -1856 -1520 R0
WINDOW 0 -89 29 Left 2
WINDOW 3 -43 61 Right 2
SYMATTR InstName B22
SYMATTR Value V= if( V(a_c) > 0 , 1, -1 )
SYMBOL bv -2080 -448 R0
WINDOW 3 49 63 Left 2
WINDOW 0 -86 56 Left 2
SYMATTR Value V=  V(a_c_mag) * {D_min / (Fs * L ) }
SYMATTR InstName B6
SYMBOL bv -2080 -272 R0
WINDOW 3 48 59 Left 2
WINDOW 0 -95 58 Left 2
SYMATTR Value V=  max( V(I_pk_mag), V(I_pk_min_mag)  )
SYMATTR InstName B10
SYMBOL bv -2080 -624 R0
WINDOW 3 45 56 Left 2
WINDOW 0 -92 30 Left 2
SYMATTR Value V=  ( V(Vc) - {SlopeAmp} * V(dc) ) / {Ri}
SYMATTR InstName B26
SYMBOL bv -288 -368 R0
WINDOW 0 32 141 Left 2
WINDOW 3 36 166 Left 2
SYMATTR InstName B27
SYMATTR Value V= if( V(mode_det) > 1, V(c_CCM), V(c_DCM)  )
SYMBOL cap -928 -336 R0
WINDOW 0 61 21 Left 2
WINDOW 3 56 43 Left 2
SYMATTR InstName Cs
SYMATTR Value { Cs }
SYMBOL res -592 -384 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R19
SYMATTR Value 1m
SYMBOL ind -480 -384 R90
WINDOW 0 5 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName L2
SYMATTR Value {L}
SYMBOL res -96 -384 R90
WINDOW 0 60 73 VBottom 2
WINDOW 3 64 64 VTop 2
SYMATTR InstName R15
SYMATTR Value {1*R_lp}
SYMBOL cap -80 -352 R0
WINDOW 0 54 12 Left 2
WINDOW 3 52 35 Left 2
SYMATTR InstName C4
SYMATTR Value 10p
SYMBOL voltage -832 -368 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 -32 56 VBottom 2
WINDOW 123 0 0 Left 2
WINDOW 39 0 0 Left 2
SYMATTR InstName Vccm
SYMATTR Value 0
SYMBOL bv -992 -960 R0
WINDOW 0 -89 55 Left 2
WINDOW 3 -51 85 Right 2
SYMATTR InstName B2
SYMATTR Value V= if( V(mode_det) > 1, I(Vccm), I(Vdcm)  )
SYMBOL res -800 -976 R90
WINDOW 0 60 73 VBottom 2
WINDOW 3 64 64 VTop 2
SYMATTR InstName R2
SYMATTR Value {1*R_lp}
SYMBOL cap -784 -912 R0
WINDOW 0 54 12 Left 2
WINDOW 3 52 35 Left 2
SYMATTR InstName C1
SYMATTR Value 10p
SYMBOL res -128 -896 R90
WINDOW 0 60 73 VBottom 2
WINDOW 3 64 64 VTop 2
SYMATTR InstName R9
SYMATTR Value {R_lp}
SYMBOL cap -112 -864 R0
WINDOW 0 54 12 Left 2
WINDOW 3 52 35 Left 2
SYMATTR InstName C3
SYMATTR Value 10p
SYMBOL e -432 -368 M0
WINDOW 0 41 77 Left 2
WINDOW 3 56 101 Left 2
SYMATTR InstName E1
SYMATTR Value 1
SYMBOL g -608 -960 R0
SYMATTR InstName Gpc
SYMATTR Value 1
SYMBOL g -992 -368 R0
WINDOW 0 -137 106 Left 2
WINDOW 3 -131 131 Left 2
SYMATTR InstName Gpc1
SYMATTR Value 1
SYMBOL voltage -832 -112 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 -32 56 VBottom 2
WINDOW 123 0 0 Left 2
WINDOW 39 0 0 Left 2
SYMATTR InstName Vdcm
SYMATTR Value 0
SYMBOL e -432 -112 M0
WINDOW 0 41 77 Left 2
WINDOW 3 56 101 Left 2
SYMATTR InstName E2
SYMATTR Value 1
SYMBOL g -992 -112 R0
WINDOW 0 -137 106 Left 2
WINDOW 3 -131 131 Left 2
SYMATTR InstName Gpc2
SYMATTR Value 1
SYMBOL res -560 -128 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R10
SYMATTR Value 1µ
SYMBOL bv -2080 96 R0
WINDOW 3 42 60 Left 2
WINDOW 0 -86 56 Left 2
SYMATTR Value V=V(I_pk)  - V(delta_I)
SYMATTR InstName B3
SYMBOL bv -2832 -1712 R0
WINDOW 0 -101 57 Left 2
WINDOW 3 -40 87 Right 2
SYMATTR InstName B4
SYMATTR Value V = ( 2 * V(I_pc) * {L} - V(a_c_lim) * (V(dc)**2) * {1/Fs} ) / ( V(a_c_lim) * V(dc) *  {1/Fs})
TEXT -880 -1912 Left 2 ;On Time Duty Cycle
TEXT -1904 -104 Left 2 ;delta I   during demag
TEXT -904 -1240 Left 2 ;Diode Conduction Duty
TEXT -848 -2392 Left 2 !.param R_lp = 10meg/Fs
TEXT -1440 -2400 Left 2 !.param L = 10u
TEXT -1440 -2432 Left 2 !.param Fs = 200k
TEXT -1440 -2304 Left 2 !.param D_min = 5
TEXT -1440 -2272 Left 2 !.param D_max = 90
TEXT -1440 -2336 Left 2 !.param SlopeAmp =0.2
TEXT -1440 -2368 Left 2 !.param Ri = 0.25
TEXT -1440 -2464 Left 2 !.param sync = 0
TEXT 280 264 Left 2 ;Drawn : Mark Dimattina
TEXT 272 176 Left 4 ;Title : PWM-CM2
TEXT 280 328 Left 2 ;Rev: 0.05
TEXT 280 296 Left 2 ;Date: 31/07/2017
TEXT 280 360 Left 2 ;M.J.Dimattina@ieee.org
TEXT 280 224 Left 2 ;Based on Christophe Basso's PWM-CM switch
TEXT -848 -2360 Left 2 !.param Cs = { 1 / ( L * ( pi * Fs)**2 ) }
TEXT -1912 -272 Left 2 ;Peak Current
RECTANGLE Normal 1136 528 -3520 -2704 2
