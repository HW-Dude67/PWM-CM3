Version 4
SHEET 1 4220 852
WIRE -1600 -4432 -1648 -4432
WIRE -1472 -4432 -1520 -4432
WIRE -1392 -4432 -1472 -4432
WIRE -1328 -4432 -1392 -4432
WIRE -944 -4432 -1024 -4432
WIRE -880 -4432 -944 -4432
WIRE -848 -4432 -880 -4432
WIRE -1648 -4416 -1648 -4432
WIRE -944 -4416 -944 -4432
WIRE -640 -4416 -704 -4416
WIRE -592 -4416 -640 -4416
WIRE -1472 -4400 -1472 -4432
WIRE -704 -4400 -704 -4416
WIRE -1744 -4384 -1824 -4384
WIRE -1648 -4320 -1648 -4336
WIRE -1472 -4320 -1472 -4336
WIRE -944 -4304 -944 -4336
WIRE -704 -4304 -704 -4320
WIRE -864 -4240 -944 -4240
WIRE -768 -4240 -864 -4240
WIRE -944 -4224 -944 -4240
WIRE -1600 -4160 -1648 -4160
WIRE -1472 -4160 -1520 -4160
WIRE -1376 -4160 -1472 -4160
WIRE -1328 -4160 -1376 -4160
WIRE -1648 -4144 -1648 -4160
WIRE -1472 -4128 -1472 -4160
WIRE -944 -4128 -944 -4144
WIRE -1728 -4112 -1792 -4112
WIRE -880 -4064 -944 -4064
WIRE -832 -4064 -880 -4064
WIRE -1648 -4048 -1648 -4064
WIRE -1472 -4048 -1472 -4064
WIRE -944 -4048 -944 -4064
WIRE -944 -3952 -944 -3968
WIRE -256 -3648 -336 -3648
WIRE -128 -3648 -176 -3648
WIRE -32 -3648 -128 -3648
WIRE 32 -3648 -32 -3648
WIRE -336 -3632 -336 -3648
WIRE -128 -3632 -128 -3648
WIRE -1808 -3552 -1888 -3552
WIRE -1728 -3552 -1808 -3552
WIRE -1152 -3552 -1216 -3552
WIRE -1072 -3552 -1152 -3552
WIRE -128 -3552 -128 -3568
WIRE -1888 -3536 -1888 -3552
WIRE -1216 -3536 -1216 -3552
WIRE -336 -3536 -336 -3552
WIRE -1888 -3440 -1888 -3456
WIRE -1216 -3440 -1216 -3456
WIRE -256 -3376 -336 -3376
WIRE -128 -3376 -176 -3376
WIRE -32 -3376 -128 -3376
WIRE 32 -3376 -32 -3376
WIRE -336 -3360 -336 -3376
WIRE -128 -3360 -128 -3376
WIRE -1856 -3344 -1888 -3344
WIRE -1728 -3344 -1856 -3344
WIRE -1168 -3344 -1216 -3344
WIRE -1088 -3344 -1168 -3344
WIRE -1888 -3328 -1888 -3344
WIRE -1216 -3328 -1216 -3344
WIRE -128 -3280 -128 -3296
WIRE -336 -3264 -336 -3280
WIRE -1888 -3232 -1888 -3248
WIRE -1216 -3232 -1216 -3248
WIRE -704 -2912 -976 -2912
WIRE -448 -2912 -624 -2912
WIRE -368 -2912 -448 -2912
WIRE -288 -2912 -368 -2912
WIRE -976 -2896 -976 -2912
WIRE -448 -2896 -448 -2912
WIRE -1728 -2880 -1744 -2880
WIRE -1664 -2880 -1728 -2880
WIRE -1744 -2864 -1744 -2880
WIRE -448 -2816 -448 -2832
WIRE -976 -2800 -976 -2816
WIRE -1744 -2768 -1744 -2784
WIRE -400 -2768 -448 -2768
WIRE -336 -2768 -400 -2768
WIRE -928 -2752 -976 -2752
WIRE -880 -2752 -928 -2752
WIRE -448 -2752 -448 -2768
WIRE -976 -2736 -976 -2752
WIRE -448 -2656 -448 -2672
WIRE -976 -2640 -976 -2656
WIRE -784 -2576 -976 -2576
WIRE -640 -2576 -704 -2576
WIRE -560 -2576 -640 -2576
WIRE -496 -2576 -560 -2576
WIRE -976 -2560 -976 -2576
WIRE -640 -2560 -640 -2576
WIRE -640 -2480 -640 -2496
WIRE -976 -2464 -976 -2480
WIRE -1568 -2224 -1664 -2224
WIRE -1264 -2224 -1568 -2224
WIRE -1104 -2224 -1264 -2224
WIRE -1264 -2208 -1264 -2224
WIRE -1664 -2176 -1664 -2224
WIRE -1104 -2176 -1104 -2224
WIRE -1360 -2128 -1360 -2208
WIRE -624 -2112 -672 -2112
WIRE -528 -2112 -624 -2112
WIRE -48 -2112 -96 -2112
WIRE 48 -2112 -48 -2112
WIRE -672 -2096 -672 -2112
WIRE -96 -2096 -96 -2112
WIRE -1664 -2048 -1664 -2096
WIRE -1264 -2048 -1264 -2064
WIRE -1104 -2048 -1104 -2096
WIRE -672 -2000 -672 -2016
WIRE -96 -2000 -96 -2016
WIRE 832 -2000 784 -2000
WIRE 928 -2000 832 -2000
WIRE 784 -1984 784 -2000
WIRE 784 -1888 784 -1904
WIRE -464 -1872 -672 -1872
WIRE -1584 -1856 -1664 -1856
WIRE -1472 -1856 -1504 -1856
WIRE -1344 -1856 -1472 -1856
WIRE -1312 -1856 -1344 -1856
WIRE -672 -1856 -672 -1872
WIRE -1664 -1840 -1664 -1856
WIRE -1472 -1840 -1472 -1856
WIRE 832 -1792 784 -1792
WIRE 928 -1792 832 -1792
WIRE 784 -1776 784 -1792
WIRE -1472 -1760 -1472 -1776
WIRE -672 -1760 -672 -1776
WIRE -1664 -1744 -1664 -1760
WIRE 784 -1680 784 -1696
WIRE -1584 -1632 -1680 -1632
WIRE -1488 -1632 -1584 -1632
WIRE -496 -1632 -672 -1632
WIRE -1680 -1616 -1680 -1632
WIRE -672 -1616 -672 -1632
WIRE -1680 -1520 -1680 -1536
WIRE -672 -1520 -672 -1536
WIRE -1328 -1312 -1456 -1312
WIRE -1104 -1312 -1232 -1312
WIRE -1456 -1280 -1456 -1312
WIRE -1232 -1280 -1232 -1312
WIRE -1456 -1168 -1456 -1200
WIRE -1232 -1168 -1232 -1200
FLAG -944 -4304 0
FLAG -1024 -4432 Vc
IOPIN -1024 -4432 In
FLAG -880 -4432 Vc
FLAG -880 -4064 I_pk
FLAG -944 -4128 0
FLAG -864 -4240 I_Pk_min
FLAG -944 -3952 0
FLAG -704 -4304 0
FLAG -640 -4416 I_pk_raw
FLAG -1888 -3440 0
FLAG -1808 -3552 Don_0
FLAG -1888 -3232 0
FLAG -976 -2800 0
FLAG -560 -2576 CCM
FLAG -448 -2816 0
FLAG -1216 -3440 0
FLAG -1216 -3232 0
FLAG -1168 -3344 Doff_1
FLAG -336 -3536 0
FLAG -32 -3648 Don_2
FLAG -128 -3552 0
FLAG -336 -3264 0
FLAG -32 -3376 Doff_2
FLAG -128 -3280 0
FLAG 784 -1888 0
FLAG 832 -2000 delta_I_demag
FLAG -96 -2000 0
FLAG -48 -2112 I_min_mag
FLAG -672 -2000 0
FLAG -624 -2112 delta_I_mag
FLAG -672 -1760 0
FLAG -464 -1872 I_mag
IOPIN -464 -1872 Out
FLAG -672 -1520 0
FLAG -496 -1632 I_demag
IOPIN -496 -1632 Out
FLAG 784 -1680 0
FLAG 832 -1792 I_min_demag
FLAG -1856 -3344 Doff_0
FLAG -1568 -2224 CCM_Ind_V
FLAG -1648 -4320 0
FLAG -1392 -4432 mag
FLAG -1472 -4320 0
FLAG -1456 -1168 0
FLAG -368 -2912 CCM_raw
FLAG -1152 -3552 Don_1
FLAG -1680 -1520 0
FLAG -1584 -1632 Ind_V
FLAG -1648 -4048 0
FLAG -1376 -4160 demag
FLAG -1472 -4048 0
FLAG -1744 -2768 0
FLAG -1728 -2880 CCM_test
FLAG -976 -2464 0
FLAG -928 -2752 tst1
FLAG -976 -2640 0
FLAG -400 -2768 tst2
FLAG -448 -2656 0
FLAG -640 -2480 0
FLAG -1664 -2048 0
FLAG -1264 -2048 0
FLAG -1104 -2048 0
FLAG -1824 -4384 V_mag
IOPIN -1824 -4384 In
FLAG -1792 -4112 V_demag
IOPIN -1792 -4112 In
FLAG -1232 -1168 0
FLAG -1360 -2128 0
FLAG -1664 -1744 0
FLAG -1344 -1856 Rs
FLAG -1472 -1760 0
DATAFLAG -1376 -1312 ""
DATAFLAG -1152 -1312 ""
SYMBOL res -960 -4432 R0
SYMATTR InstName R3
SYMATTR Value 1G
SYMBOL bv -944 -4240 R0
WINDOW 3 49 63 Left 2
WINDOW 0 49 38 Left 2
SYMATTR Value V=  V(mag) * {D_min / (Fs * L ) }
SYMATTR InstName B6
SYMBOL bv -944 -4064 R0
WINDOW 3 45 73 Left 2
WINDOW 0 42 44 Left 2
SYMATTR Value V=  max( V(I_pk_raw), V(I_pk_min)  )
SYMATTR InstName B10
SYMBOL bv -704 -4416 R0
WINDOW 3 45 56 Left 2
WINDOW 0 43 32 Left 2
SYMATTR Value V=  ( V(Vc) - {SlopeAmp} * V(don_2) ) / {Ri}
SYMATTR InstName B26
SYMBOL bv -1888 -3552 R0
WINDOW 3 54 81 Left 2
WINDOW 0 52 49 Left 2
SYMATTR Value V = {Fs * L} * V(I_pk) / V(mag)
SYMATTR InstName B21
SYMBOL bv -1888 -3344 R0
WINDOW 3 65 81 Left 2
WINDOW 0 58 41 Left 2
SYMATTR Value V = {Fs * L} * V(I_pk) / (V(demag) + 1u)
SYMATTR InstName B11
SYMBOL bv -976 -2912 R0
WINDOW 3 53 99 Left 2
WINDOW 0 50 64 Left 2
SYMATTR Value V= if (  V(CCM_test)  > 1 , 1, 0  )
SYMATTR InstName B12
SYMBOL res -608 -2928 R90
WINDOW 0 -3 55 VBottom 2
WINDOW 3 36 51 VTop 2
SYMATTR InstName R7
SYMATTR Value {100*R_lp}
SYMBOL cap -464 -2896 R0
WINDOW 0 38 10 Left 2
WINDOW 3 40 36 Left 2
SYMATTR InstName C2
SYMATTR Value 10p
SYMBOL bv -1216 -3552 R0
WINDOW 3 -73 -49 Left 2
WINDOW 0 46 49 Left 2
SYMATTR Value V= limit( V(demag) / ( V(mag) + V(demag)  ), {D_min}, {D_max} )
SYMATTR InstName B14
SYMBOL bv -1216 -3344 R0
WINDOW 3 221 89 Right 2
WINDOW 0 54 54 Left 2
SYMATTR Value V=  1- V(Don_1)
SYMATTR InstName B15
SYMBOL bv -336 -3648 R0
WINDOW 3 -22 184 Left 2
WINDOW 0 -18 153 Left 2
SYMATTR Value V= limit(  min( V(Don_1), V(Don_0)  ),  {D_min}, {D_max} )
SYMATTR InstName B16
SYMBOL res -160 -3664 R90
WINDOW 0 -3 55 VBottom 2
WINDOW 3 36 51 VTop 2
SYMATTR InstName R17
SYMATTR Value {1*R_lp}
SYMBOL cap -144 -3632 R0
WINDOW 0 38 10 Left 2
WINDOW 3 40 36 Left 2
SYMATTR InstName C10
SYMATTR Value 10p
SYMBOL bv -336 -3376 R0
WINDOW 3 -7 199 Left 2
WINDOW 0 -18 163 Left 2
SYMATTR Value V = min (  V(Doff_1), V(Doff_0)  )
SYMATTR InstName B18
SYMBOL res -160 -3392 R90
WINDOW 0 -3 55 VBottom 2
WINDOW 3 36 51 VTop 2
SYMATTR InstName R18
SYMATTR Value {1*R_lp}
SYMBOL cap -144 -3360 R0
WINDOW 0 38 10 Left 2
WINDOW 3 40 36 Left 2
SYMATTR InstName C11
SYMATTR Value 10p
SYMBOL bv 784 -2000 R0
WINDOW 3 46 83 Left 2
WINDOW 0 49 51 Left 2
SYMATTR Value V= V(demag) * V(Doff_2) / {L * Fs}
SYMATTR InstName B23
SYMBOL bv -96 -2112 R0
WINDOW 3 44 73 Left 2
WINDOW 0 45 46 Left 2
SYMATTR Value V= V(I_pk) - V(delta_I_mag)
SYMATTR InstName B24
SYMBOL bv -672 -2112 R0
WINDOW 3 44 71 Left 2
WINDOW 0 42 45 Left 2
SYMATTR Value V= V(mag) * V(Don_2) / {L * Fs}
SYMATTR InstName B25
SYMBOL bv -672 -1872 R0
WINDOW 3 42 80 Left 2
WINDOW 0 42 49 Left 2
SYMATTR Value V= ( V(I_min_mag) + V(delta_I_mag)/2  ) * V(Don_2)
SYMATTR InstName B28
SYMBOL bv -672 -1632 R0
WINDOW 3 46 76 Left 2
WINDOW 0 47 54 Left 2
SYMATTR Value V= ( V(I_pk) - V(delta_I_mag)/2  ) * V(Doff_2)
SYMATTR InstName B29
SYMBOL bv 784 -1792 R0
WINDOW 3 42 76 Left 2
WINDOW 0 47 49 Left 2
SYMATTR Value V= V(I_pk) - V(delta_I_mag)
SYMATTR InstName B30
SYMBOL cap -1280 -2208 R0
WINDOW 0 61 21 Left 2
WINDOW 3 56 43 Left 2
SYMATTR InstName Cs1
SYMATTR Value { Cs }
SYMBOL ind -1120 -2192 R0
SYMATTR InstName L1
SYMATTR Value {L}
SYMATTR SpiceLine Rser=0.1u
SYMBOL bv -1648 -4432 R0
WINDOW 3 277 173 Right 2
WINDOW 0 -9 150 Left 2
SYMATTR Value V=  V(V_mag) - V(Ind_V)
SYMATTR InstName B5
SYMBOL res -1504 -4448 R90
WINDOW 0 -7 58 VBottom 2
WINDOW 3 32 58 VTop 2
SYMATTR InstName R11
SYMATTR Value {1 * R_lp}
SYMBOL cap -1488 -4400 R0
SYMATTR InstName C4
SYMATTR Value 10p
SYMBOL voltage -1456 -1296 R0
SYMATTR InstName V1
SYMATTR Value {Cs}
SYMBOL bv -1680 -1632 R0
WINDOW 0 49 36 Left 2
WINDOW 3 44 68 Left 2
SYMATTR InstName B4
SYMATTR Value V= limit( V(CCM_Ind_V), -1*V(V_demag) + 1m, (V(V_mag) - 1m) )
SYMBOL bv -1648 -4160 R0
WINDOW 3 314 181 Right 2
WINDOW 0 -8 152 Left 2
SYMATTR Value V=  V(V_demag) + V(Ind_V)
SYMATTR InstName B20
SYMBOL res -1504 -4176 R90
WINDOW 0 -7 58 VBottom 2
WINDOW 3 32 58 VTop 2
SYMATTR InstName R13
SYMATTR Value {R_lp}
SYMBOL cap -1488 -4128 R0
SYMATTR InstName C8
SYMATTR Value 10p
SYMBOL bv -1744 -2880 R0
WINDOW 3 51 65 Left 2
WINDOW 0 54 36 Left 2
SYMATTR Value V= limit( V(Don_0) + V(Doff_0), 0, 2)
SYMATTR InstName B7
SYMBOL bv -976 -2576 R0
WINDOW 3 53 148 Left 2
WINDOW 0 54 106 Left 2
SYMATTR Value V= if( sync > 0.5, 1, if( V(CCM_test) > 1,  V(tst1), V(tst2) )  )
SYMATTR InstName B13
SYMBOL bv -976 -2752 R0
WINDOW 3 62 77 Left 2
WINDOW 0 60 42 Left 2
SYMATTR Value V= if( V(CCM_raw) > 0.9, 1, 0 )
SYMATTR InstName B19
SYMBOL bv -448 -2768 R0
WINDOW 3 63 83 Left 2
WINDOW 0 68 49 Left 2
SYMATTR Value V= if( V(CCM_raw) < 0.1, 0, 1 )
SYMATTR InstName B27
SYMBOL res -688 -2592 R90
WINDOW 0 -3 55 VBottom 2
WINDOW 3 36 51 VTop 2
SYMATTR InstName R1
SYMATTR Value {10*R_lp}
SYMBOL cap -656 -2560 R0
WINDOW 0 38 10 Left 2
WINDOW 3 40 36 Left 2
SYMATTR InstName C5
SYMATTR Value 10p
SYMBOL bi -1664 -2096 R180
WINDOW 0 -92 38 Left 2
WINDOW 3 -47 15 Right 2
SYMATTR InstName B32
SYMATTR Value I = V(I_min_mag)
SYMBOL res -1280 -2160 R0
WINDOW 0 62 40 Left 2
WINDOW 3 59 73 Left 2
SYMATTR InstName Rs1
SYMATTR Value R = V(Rs)
SYMBOL bv -1664 -1856 R0
WINDOW 0 45 54 Left 2
WINDOW 3 239 84 Left 2
SYMATTR InstName B1
SYMATTR Value V= if( V(CCM) > 0.5, {Rs_CCM}, {Rs_DCM}  )
SYMBOL bv -1232 -1296 R0
WINDOW 0 45 54 Left 2
WINDOW 3 43 81 Left 2
SYMATTR InstName B2
SYMATTR Value V= V(Rs)
SYMBOL res -1488 -1872 R90
WINDOW 0 10 125 VBottom 2
WINDOW 3 -25 23 VTop 2
SYMATTR InstName R2
SYMATTR Value {100*R_lp}
SYMBOL cap -1488 -1840 R0
WINDOW 0 38 10 Left 2
WINDOW 3 40 36 Left 2
SYMATTR InstName C1
SYMATTR Value 10p
TEXT 96 -4344 Left 2 !.param R_lp = 0.1meg/Fs
TEXT 96 -4560 Left 2 !.param L = 10u
TEXT 96 -4592 Left 2 !.param Fs = 200k
TEXT 96 -4464 Left 2 !.param D_min = 0.05
TEXT 96 -4432 Left 2 !.param D_max = 0.90
TEXT 96 -4496 Left 2 !.param SlopeAmp =0.2
TEXT 96 -4528 Left 2 !.param Ri = 0.25
TEXT 96 -4624 Left 2 !.param sync = 0
TEXT 192 -1664 Left 2 ;Drawn : Mark Dimattina
TEXT 184 -1752 Left 4 ;Title : PWM-CM3
TEXT 192 -1600 Left 2 ;Rev: 0.02
TEXT 192 -1632 Left 2 ;Date:10/06/2024
TEXT 192 -1568 Left 2 ;M.J.Dimattina@ieee.org
TEXT -1520 -2008 Left 2 !.param Cs = { 1 / ( L * (pi * Fs)**2 ) }
TEXT -800 -4088 Left 2 ;Peak Current
TEXT -1888 -3840 Left 2 ;V = L di/dt
TEXT -1888 -3808 Left 2 ;dt = L * di / V
TEXT 960 -2008 Left 2 ;delta I   during demag
TEXT -680 -2176 Left 2 ;di =V * dt /  L
TEXT -496 -2120 Left 2 ;delta I   during mag
TEXT -648 -1928 Left 2 ;Magentizing Current
TEXT -640 -1680 Left 2 ;De-magentizing Current
TEXT -1936 -3608 Left 2 ;On Time Duty Cycle
TEXT -1936 -3392 Left 2 ;Off Time Duty Cycle
TEXT -1768 -2928 Left 2 ;When Don + Doff > 1
TEXT -1264 -3704 Left 2 ;Don_1 = Don_0 / ( Don_0 + Doff_0 )
TEXT -1256 -3656 Left 2 ;simplifies to ->
TEXT -1888 -3752 Left 5 ;DCM
TEXT -1176 -3760 Left 5 ;CCM
TEXT -264 -3776 Left 5 ;Mode Toggle
TEXT -1344 -3072 Left 5 ;Mode Selection
TEXT -712 -2256 Left 5 ;Current Calculation
TEXT -1672 -2344 Left 5 ;Induced Inductor Voltage
TEXT -928 -4536 Left 5 ;Peak Current
TEXT -928 -2976 Left 2 ;Hysteresis to improve transient simulation speed
TEXT -1736 -4528 Left 5 ;Inductor Voltage
TEXT -1736 -4584 Left 5 ;Mag / Demag
TEXT -1520 -1968 Left 2 !.param Rs_CCM = { sqrt( L / Cs ) / Q }
TEXT -1720 -1968 Left 2 !.param Q = 10
TEXT -1520 -1928 Left 2 !.param Rs_DCM = { sqrt( L / Cs ) / 0.5 }
RECTANGLE Normal 640 -1472 -2016 -4704 2
